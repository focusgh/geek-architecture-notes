[toc]

## 91 | 项目实战一：设计实现一个支持各种算法的限流框架（设计）

1.  这里的“设计”指的是系统设计，主要是划分模块，对模块进行设计。
2.  今天，我们分限流规则、限流算法、限流模块、集成使用这4 个模块，来讲解限流框架的设计思路。

### 限流规则

1.  框架需要定义**限流规则的语法格式**，包括调用方、接口、限流阈值、时间粒度这几个元素。框架用户按照这个语法格式来配置限流规则。

    -   ```yaml
        
        configs:
        - appId: app-1
          limits:
          - api: /v1/user
            limit: 100
            unit：60
          - api: /v1/order
            limit: 50
        - appId: app-2
          limits:
          - api: /v1/user
            limit: 50
          - api: /v1/order
            limit: 50
        ```

    -   

### 限流算法

1.  常见的限流算法有：**固定时间窗口限流算法**、滑动时间窗口限流算法，令牌桶限流算法、漏桶限流算法。其中，固定时间窗口限流算法最简单。
2.  此外，为了提高框架的易用性、灵活性，我们最好将其他几个常用的限流算法，也在框架中实现出来，供框架用户自由选择。

### 限流模式

1.  我们把限流模式分为两种：**单机限流**和**分布式限流**。
2.  **单机限流**，就是针对单个实例的访问频率进行限制。
3.  **分布式限流**，就是针对某个服务的多个实例的总的访问频率进行限制。
4.  单机限流和分布式限流的主要区别在于，**接口访问计数器的实现**。
    -   单机限流只需要在单个实例中维护自己的接口请求计数器。
    -   分布式限流需要集中管理计数器，这样才能做到多个实例对同一个计数器累加计数，以便实现对多个实例总访问频率的限制。
5.  非功能需求，高容错、低延迟

### 集成使用

1.  限流框架也应该要满足**低侵入、松耦合**的设计思想。
2.  此外，还需要考虑框架的**易用性**，让我们能够方便的集成到其他框架使用。

### 重点回顾

1.  我们将这个限流框架划分为**限流规则、限流算法、限流模式、集成使用**这四个模块来分析。此外，我们还重点讲了如何满足**易用、灵活、易扩展、低延迟、高容错**，这些非功能需求。
2.  限流规则
    -   最小惊奇原则
    -   约定优于配置设计原则
    -   兼容性、易用性
3.  限流算法
    -   设计默认
    -   考虑扩展性、易用性、灵活性
4.  限流模块
    -   针对分布式限流模式，考虑高容错、低延迟
5.  集成使用
    -   框架低侵入，跟业务松耦合。
    -   考虑框架易用性。

