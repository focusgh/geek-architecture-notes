[toc]

## 15 | Kafka 如何实现高性能 IO ？

1.  性能优化方面，Kafka 还有哪些“独门绝技”？

### 使用批量消息提升服务端处理能力

1.  Kafka 采用了**批量发送机制**。简单地说，就是**攒一波一起发**。
2.  **批消息不会被解开，一直是作为一条“批消息”来进行处理**。
3.  批消息减轻了 Broker 的压力，最重要的是**减少了 Broker 处理请求的次数**，提升了总体的处理能力。

### 使用顺序读写提升磁盘 IO 性能

1.  磁盘读写
    -   先寻址
    -   再进行数据读写
2.  **顺序读写相比随机读写省去了大部分的寻址时间，性能要远远好于随机读写**。
3.  Kafka 把从 Producer 收到的消息，顺序写入对应的 log 文件中。消费的时候，也是从某个文件的某个位置开始，顺序地把消息读出来。
4.  这样简单的设计，充分利用了顺序读写这个特性，极大提升了 IO 性能。

### 利用 PageCache 加速消息读写

1.  **PageCache 就是操作系统在内存中给磁盘上的文件建立的缓存**。
2.  Kafka 在读写消息文件时，充分利用了 PageCache 的特性。一般来说，消息刚刚写入到服务端就会被消费，读取时，对于这种刚刚写入的 PageCache。命中几率会非常高。
3.  消费消息都会命中 PageCache，带来好处有两个：
    -   读取速度会非常快
    -   给写入消息让出磁盘 IO 资源，间接提升写入的性能。

### ZeroCopy：零拷贝技术

1.  在服务端，处理消费的大致逻辑

    -   首先，从文件找到消息数据，读到内存中。
    -   然后，把消息通过网络发送给客户端。

2.  数据复制

    -   从文件复制数据到 PageCache 中，如果命中 PageCache，这步可以省去。
    -   从 PageCache 复制到应用程序的内存空间中。
    -   从应用程序的内存空间复制到 Socket 的缓冲区。

3.  零拷贝技术可以把上面的 2、3 步复制合成一次复制。直接从 PageCache 中把数据复制到 Socket 缓冲区中。

    -   这样不仅减少一次复制。
    -   由于不用把数据复制到用户内存空间，DMA 控制器可以直接完成数据复制，不需要 CPU 参与，速度更快。

4.  零拷贝对应的系统调用

    -   ```C
        
        #include <sys/socket.h>
        ssize_t sendfile(int out_fd, int in_fd, off_t *offset, size_t count);
        ```

    -   

### 小结

1.  Kafka 高性能设计中的几个关键技术点
    -   批处理
    -   磁盘顺序读写
    -   利用 PageCache 缓存数据
    -   零拷贝技术



