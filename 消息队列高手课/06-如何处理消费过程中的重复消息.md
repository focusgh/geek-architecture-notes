[toc]

## 06 | 如何处理消费过程中的重复消息？

1.  有没有消息队列能保证消息不重复呢？

### 消息重复的情况是必然存在

1.  MQTT 协议中，三种服务质量从低到高依次是：
    -   **At most once: 至多一次**。
    -   **At least once: 至少一次**。
    -   **Exactly once: 恰好一次**。
2.  常用的大部分消息队列都是 At least once。也就是说，**消息队列很难保证消息不重复**。

### 用幂等性解决重复消息问题

1.  一般解决重复消息的办法是，**在消费端，让我们消费消息的操作具备幂等性**。

    >   **幂等**
    >
    >   
    >
    >   如果一个函数 f(x) 满足：f(f(x)) = f(x)，则函数 f(x) 满足幂等性。

    -   一个幂等操作的特征是，**其任意多次执行所产生的影响均与一次执行的影响相同**。

2.  从对系统的影响结果来说：

    -   **At least once + 幂等消费 = Exactly once**。

3.  如何实现幂等操作呢？

    -   最好的方式就是，**从业务逻辑设计上手，将消费的业务逻辑设计成具备幂等性的操作**。

4.  下面，我们一起看看几种常用的方法

#### 1. 利用数据库的唯一约束实现幂等

1.  对于转账操作，我们可以限定，对于每个转账单每个账户只可以执行一次变更操作。我们可以，给账单 ID 和账户 ID 这两个字段联合起来**创建一个唯一约束**。

2.  只要支持类似 “**INSERT IF NOT EXIST**” 语义的，都可以用于实现幂等。如 Redis 的 SETNX 命令。

#### 2. 为更新的数据设置前置条件

1.  **给数据变更设置一个前置条件，如果满足条件就更新，否则拒绝更新**。
    -   如果账户 x 当前的余额为 500 元，则加 100。
2.  一个更加通用的方法：
    -   给你的数据增加一个版本号属性。
    -   每次更新前，比较当前版本号是否和消息中版本号一致，如果不一致就拒绝更新，更新数据同时将版本号 +1，一样可以实现幂等更新。

#### 3. 记录并检查操作

1.  还有一种通用性最强，适用范围最广的实现幂等性方法：
    -   **记录并检查操作**，也称 “Token 机制或 GUID（全局唯一 ID）机制”。
    -   实现思路：在执行数据更新操作前，先检查一下是否执行过这个更新操作。
2.  在分布式系统中，这个方法其实是非常难实现的。
    -   **检查消息状态、更新数据、设置消费状态**。三个操作必须保证原子性。

### 小结

1.  本节，我们主要介绍了通过幂等消费来解决消息重复的问题。几种实现幂等操作的方法：
    -   利用数据库的约束来防止重复更新数据
    -   为数据更新设置一次性的前置条件
    -   “记录并检查操作”来保证幂等