[toc]

## 04 | 如何利用事务消息实现分布式事务？

1.  消息队列中的“事务”，主要解决的是消息生产者和消息消费者的**数据不一致**的问题。
2.  订单系统创建订单
    -   ![img](imgs/d6efbd1a48cb0d1cd352587f233c2500.jpg)
3.  我们需要解决的问题：保证订单库和购物车库，这两个库的数据一致性。

### 什么是分布式事务？

1.  什么是事务？
    -   对数据的更新操作，**要么都成功，要么都失败**。
2.  事务的 4 个属性： (ACID)
    -   **原子性**
    -   **一致性**
    -   **隔离性**
    -   **持久性**
3.  事务消息适用的**场景**：
    -   **主要是那些需要异步更新数据，并且对数据实时性要求不高的场景**。

### 消息队列是如何实现分布式事务的？

1.  订单和购物车的例子中，如何用消息队列来实现分布式事务。
    -   ![img](imgs/27ebf12e0dc79e00e1e42c8ff0f4e2e6.jpg)
2.  半消息和普通消息的唯一区别是，在事务提交前，对于消费者来说，这个消息是**不可见**的。
3.  如果第 4 步，提交事务消息时失败了怎么办？
    -   Kafka
        -   直接抛出异常，让用户自行处理。
    -   RocketMQ
        -   给出另一个解决方案，如下。

### RocketMQ 中分布式事务实现

1.  在 RocketMQ 中的事务实现中，增加了**事务反查的机制**来解决事务消息提交失败的问题。
    -   在业务代码中，需要实现一个反查本地事务状态的接口。
2.  RocketMQ 事务消息功能实现分布式事务的流程图，如下
    -   ![img](imgs/11ea249b164b893fb9c36e86ae32577a.jpg)

### 小结

1.  事务的 ACID 特性。
2.  如何使用消息队列来实现分布式事务。
3.  RocketMQ 的事务反查机制 

