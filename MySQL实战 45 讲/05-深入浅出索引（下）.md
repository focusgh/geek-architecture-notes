[toc]

## 05 | 深入浅出索引（下）

-   问题：在下面这个表 T 中，如果执行 `select * from T where k between 3 and 5;`，需要执行几次树的搜索操作，会扫描多少行？

    -   表的初始化语句

    -   ```mysql
        
        mysql> create table T (
        ID int primary key,
        k int NOT NULL DEFAULT 0, 
        s varchar(16) NOT NULL DEFAULT '',
        index k(k))
        engine=InnoDB;
        
        insert into T values(100,1, 'aa'),(200,2,'bb'),(300,3,'cc'),(500,5,'ee'),(600,6,'ff'),(700,7,'gg');
        ```

    -   B+ 索引树

    -   ![img](imgs/dcda101051f28502bd5c4402b292e38d-20200414094943866.png)

-   这条 SQL 查询语句的执行流程：

    1.  在 k 索引树上找到 k=3 的记录，取得 ID=300。
    2.  再到 ID 索引树查到 ID=300 对应的 R3。
    3.  在 k 索引树取下一个值 k=5 的记录，取得 ID=500。
    4.  再到 ID 索引树查到 ID=500 对应的 R4。
    5.  在 k 索引树取下一个值 k=6，不满足条件，循环结束。

-   这个例子中，由于查询结果所需要的数据只在主键索引上有，所以不得不回表。那么，有没有可能经过索引优化，避免回表过程呢？

### 覆盖索引

-   如果执行语句是 `select ID from T where k between 3 and 5;`，这时只需要查 ID 的值，而 ID 的值已经在 k 索引树上了，因此可以直接提供查询结果，不需要回表。
-   在这个查询里面，索引 k 已经覆盖了我们的查询需求，我们称为**覆盖索引**。
-   **覆盖索引可以减少树的搜索次数，显著提升查询性能，所以使用覆盖索引是一个常用的性能优化手段**。

### 最右前缀原则

-   **B+ 树这种索引结构，可以利用索引的“最左前缀”，在定位记录**。
-   联合索引示意图：
    -   ![img](imgs/89f74c631110cfbc83298ef27dcd6370.jpg)
    -   索引项是按照索引定义里面出现的字段顺序排序的。
-   **只要满足最左前缀，就可以利用索引来加速检索**。这个最左前缀可以是联合索引的最左 N 个字段，也可以是字符串索引的最左 M 个字符。
-   如：`where name like ‘张 %’`， 也能够用上这个索引。
-   **在建立联合索引的时候，如何安排索引内的字段顺序**？
    -   第一原则是，如果通过调整**顺序**，可以少维护一个索引，那么这个顺序往往就是需要优先考虑采用的。
    -   其次，我们要考虑的原则就是**空间**。

### 索引下推

-   如下 SQL 语句为例：

    -   ```mysql
        
        mysql> select * from tuser where name like '张%' and age=10 and ismale=1;
        ```

-   `name like '张%'` 可以用到上面讲到的前缀索引。

-   然后呢？需要判断其他条件是否满足。

    -   在 MySQL 5.6 前，只能从 ID3 开始一个个回表。到主键索引上找出数据行，再对比字段值。
    -   在 MySQL 5.6 引入的索引下推优化，可以在索引遍历过程中，对索引中包含的字段先做判断，直接过滤掉不满足条件的记录，减少回表次数。
    -   无索引下推执行流程
    -   ![img](imgs/b32aa8b1f75611e0759e52f5915539ac.jpg)
    -   索引下推执行流程
    -   ![img](imgs/76e385f3df5a694cc4238c7b65acfe1b.jpg)
    -   上图中，InnoDB 在索引内部就判断了 age 是否等于 10，对于不等于的记录，直接判断并跳过。只需要对 ID4、ID5 这两条记录回表取数据判断，就只需要回表 2 次。

### 小结

-   今天，我们一起讨论了覆盖索引、前缀索引、索引下推。
-   在满足语句需求的情况下，尽量少地访问资源是数据库设计的重要原则之一。
-   在使用数据库的时候，尤其是在设计表结构时，也要以减少资源消耗作为目标。