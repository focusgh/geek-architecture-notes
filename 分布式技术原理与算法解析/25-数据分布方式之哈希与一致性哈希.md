[toc]

## 25 | 数据分布方式之哈希与一致性哈希：“掐指一算”与“掐指两算”的事

### 数据分布设计原则

-   存储方案选型时，需要考虑的三个维度：
    -   **数据均匀**
    -   **数据稳定**
    -   **节点异构性**
-   其他：
    -   **隔离故障域**
    -   **性能稳定性**

### 数据分布方法

-   **哈希**是指，**将数据按照提前规定好的函数（哈希函数）映射到相应的存储节点**，即进行一个哈希计算，得到的结果就是数据应该存储的节点。
-   **一致性哈希**同样是采用哈希函数，进行两步哈希：
    1.  **对存储节点进行哈希计算**，也就是对存储节点做哈希映射。
    2.  当对数据进行存储或访问时，首先对数据进行映射得到一个结果，然后找到比该结果大的第一个存储节点，就是该数据应该存储的地方。

#### 哈希

-   哈希是一种非常常用的数据分片方法，其核心思想是，首先确定一个哈希函数，然后通过计算得到对应的存储节点。
-   示例：
    -   有三个存储节点，分别是 Node1、Node2、Node3。
    -   哈希函数 `id%3`，通过计算可以得到每个数据应该存入的节点。
    -   ![img](imgs/ff2578a3e75e85ffb8a3f63f87bc8600.png)
-   优点
    -   只要哈希函数设置得当，可以很好地保证数据均匀性。
-   缺点
    -   但有一个较为严重的缺点，就是稳定性较差。
    -   如果，三个节点的容量无法再满足存储需求，需要再加一个节点。哈希函数变成了 `id%4`，原先存储在那三个节点的数据需要重新计算，然后存入相应的节点，即需要大规模的数据迁移，显然，会降低稳定性。
-   哈希方法适用于**同类型节点且节点数据比较固定的场景**。

#### 一致性哈希

-   一致性哈希是指将存储节点和数据都映射到一个首尾相连的哈希环上，存储节点可以根据 IP 地址进行哈希，数据通常通过顺时针方向寻找的方式，来确定自己所属的存储节点，即从数据映射在环上的位置开始，顺时针方向找到第一个存储节点。

#### 带有限限负载的一致性哈希

#### 带虚拟节点的一致性哈希

### 四种数据分布方法对比

### 扩展：数据分片和数据分区，有何区别？

### 总结



